<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色聊天测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-connect {
            background-color: #27ae60;
        }
        
        .btn-connect:hover {
            background-color: #219653;
        }
        
        .btn-disconnect {
            background-color: #e74c3c;
        }
        
        .btn-disconnect:hover {
            background-color: #c0392b;
        }
        
        .btn-voice {
            background-color: #9b59b6;
        }
        
        .btn-voice:hover {
            background-color: #8e44ad;
        }
        
        .btn-stop {
            background-color: #e67e22;
        }
        
        .btn-stop:hover {
            background-color: #d35400;
        }
        
        .chat-container {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
        }
        
        .ai-message {
            background-color: #e8f5e9;
            margin-right: auto;
        }
        
        .system-message {
            background-color: #f5f5f5;
            margin: 0 auto;
            text-align: center;
            max-width: 100%;
            font-size: 14px;
        }
        
        .error-message {
            background-color: #ffebee;
            margin: 0 auto;
            text-align: center;
            max-width: 100%;
            font-size: 14px;
        }
        
        .voice-message {
            background-color: #e1f5fe;
        }
        
        .status {
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .connecting {
            background-color: #fff8e1;
            color: #f57f17;
        }
        
        .recording {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .message-header {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        
        .message-content {
            font-size: 16px;
            line-height: 1.5;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .mode-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-option.selected {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .voice-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        
        .upload-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .upload-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .upload-error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>角色聊天测试</h1>
        
        <div class="input-group">
            <label for="jwtToken">JWT令牌：</label>
            <input type="text" id="jwtToken" placeholder="输入您的JWT令牌">
        </div>
        
        <div class="input-group">
            <label for="roleId">角色ID：</label>
            <input type="number" id="roleId" placeholder="输入角色ID" value="1">
        </div>
        
        <div class="input-group">
            <label>回复模式：</label>
            <div class="mode-selector">
                <div class="mode-option" data-mode="0">文字回复</div>
                <div class="mode-option" data-mode="1">语音回复</div>
                <div class="mode-option" data-mode="2">随机回复</div>
            </div>
        </div>
        
        <button id="connectBtn" class="btn-connect">连接WebSocket</button>
        <button id="disconnectBtn" class="btn-disconnect" style="display:none;">断开连接</button>
        
        <div id="status" class="status disconnected">未连接</div>
        
        <div class="input-group">
            <label for="message">消息内容：</label>
            <textarea id="message" placeholder="输入要发送的消息"></textarea>
        </div>
        
        <button id="sendBtn" disabled>发送文本消息</button>
        
        <div class="input-group">
            <label>语音消息：</label>
            <div class="voice-controls">
                <button id="recordBtn" class="btn-voice" disabled>开始录音</button>
                <button id="stopBtn" class="btn-stop" disabled>停止录音</button>
                <button id="sendVoiceBtn" class="btn-voice" disabled>发送语音</button>
            </div>
            <div id="recordingStatus" class="status" style="display:none;">
                <span class="recording-indicator"></span>正在录音...
            </div>
            <div id="uploadStatus" class="upload-status"></div>
        </div>
        
        <div class="chat-container">
            <h2>聊天记录</h2>
            <div id="chatMessages" class="chat-messages">
                <div class="message system-message">聊天记录将显示在这里</div>
            </div>
        </div>
    </div>

    <script>
        // DOM元素
        const jwtTokenInput = document.getElementById('jwtToken');
        const roleIdInput = document.getElementById('roleId');
        const messageInput = document.getElementById('message');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const sendVoiceBtn = document.getElementById('sendVoiceBtn');
        const statusDiv = document.getElementById('status');
        const recordingStatusDiv = document.getElementById('recordingStatus');
        const uploadStatusDiv = document.getElementById('uploadStatus');
        const chatMessagesDiv = document.getElementById('chatMessages');
        const modeOptions = document.querySelectorAll('.mode-option');
        
        let socket = null;
        let selectedMode = 0; // 默认文字回复
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let audioUrl = null; // 存储上传后的音频URL
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const BASE_URL = 'https://ai.mcell.top';
        
        // 初始化模式选择
        modeOptions.forEach(option => {
            option.addEventListener('click', () => {
                modeOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedMode = parseInt(option.dataset.mode);
            });
        });
        
        // 默认选择文字回复
        modeOptions[0].classList.add('selected');
        
        // 连接WebSocket
        function connectWebSocket() {
            const jwtToken = jwtTokenInput.value.trim();
            const roleId = roleIdInput.value.trim();
            
            if (!jwtToken) {
                alert('请输入JWT令牌');
                return;
            }
            
            if (!roleId) {
                alert('请输入角色ID');
                return;
            }
            
            // 更新状态
            statusDiv.textContent = '连接中...';
            statusDiv.className = 'status connecting';
            connectBtn.disabled = true;
            
            try {
                // 创建WebSocket连接，使用固定的8080端口
                socket = new WebSocket(`ws://localhost:8080/api/ws/chat?token=${jwtToken}`);
                
                // 连接成功
                socket.onopen = () => {
                    reconnectAttempts = 0;
                    statusDiv.textContent = '已连接';
                    statusDiv.className = 'status connected';
                    sendBtn.disabled = false;
                    recordBtn.disabled = false;
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'block';
                    addMessage('系统', 'WebSocket连接已建立', 'system');
                };
                
                // 接收消息
                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.error) {
                            addMessage('系统', `错误: ${data.error}`, 'error');
                        } else if (data.type === 'voice') {
                            // 处理语音回复
                            const audioSrc = data.message; // 这里应该是URL
                            
                            // 创建音频元素
                            const audio = document.createElement('audio');
                            audio.controls = true;
                            audio.src = audioSrc;
                            audio.className = 'audio-player';
                            
                            addMessage('AI', '语音回复', 'ai', audio);
                        } else {
                            // 处理文本回复
                            addMessage('AI', data.message, 'ai');
                        }
                    } catch (e) {
                        addMessage('系统', `消息解析错误: ${e.message}`, 'error');
                    }
                };
                
                // 错误处理
                socket.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    addMessage('系统', `WebSocket错误: ${error.message || '未知错误'}`, 'error');
                    statusDiv.textContent = '连接错误';
                    statusDiv.className = 'status disconnected';
                    sendBtn.disabled = true;
                    recordBtn.disabled = true;
                    connectBtn.disabled = false;
                    connectBtn.style.display = 'block';
                    disconnectBtn.style.display = 'none';
                    
                    // 尝试重新连接
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                        addMessage('系统', `尝试重新连接 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, 'system');
                    }
                };
                
                // 连接关闭
                socket.onclose = (event) => {
                    console.log('WebSocket关闭:', event);
                    addMessage('系统', `WebSocket连接已关闭 (代码: ${event.code}, 原因: ${event.reason || '无'})`, 'system');
                    statusDiv.textContent = '未连接';
                    status极狐.className = 'status disconnected';
                    sendBtn.disabled = true;
                    recordBtn.disabled = true;
                    connectBtn.disabled = false;
                    connectBtn.style.display = 'block';
                    disconnectBtn.style.display = 'none';
                    
                    // 尝试重新连接
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                        addMessage('系统', `尝试重新连接 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, 'system');
                    }
                };
                
            } catch (error) {
                console.error('连接失败:', error);
                addMessage('系统', `连接失败: ${error.message}`, 'error');
                statusDiv.textContent = '连接失败';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                
                // 尝试重新连接
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                    addMessage('系统', `尝试重新连接 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, 'system');
                }
            }
        }
        
        // 绑定连接按钮
        connectBtn.addEventListener('click', connectWebSocket);
        
        // 断开WebSocket连接
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close(1000, '用户手动断开');
                socket = null;
            }
            
            statusDiv.textContent = '未连接';
            statusDiv.className = 'status disconnected';
            sendBtn.disabled = true;
            recordBtn.disabled = true;
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
            addMessage('系统', '已断开WebSocket连接', 'system');
        });
        
        // 发送文本消息
        sendBtn.addEventListener('click', () => {
            const roleId = roleIdInput.value.trim();
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('请输入消息内容');
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('WebSocket未连接');
                return;
            }
            
            // 发送消息
            try {
                const messageData = {
                    role_id: parseInt(roleId),
                    message: message,
                    type: "text",
                    response_type: selectedMode
                };
                
                socket.send(JSON.stringify(messageData));
                
                // 在界面上显示用户消息
                addMessage('用户', message, 'user');
                
                // 清空输入框
                messageInput.value = '';
            } catch (error) {
                addMessage('系统', `发送失败: ${error.message}`, 'error');
            }
        });
        
        // 开始录音
        recordBtn.addEventListener('click', async () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('请先连接WebSocket');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // 创建预览播放器
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = audioUrl;
                    audio.className = 'audio-player';
                    
                    addMessage('用户', '语音消息预览', 'user', audio);
                    
                    // 上传语音文件 - 使用实际的公网地址
                    try {
                        uploadStatusDiv.textContent = "正在上传语音文件...";
                        uploadStatusDiv.className = "upload-status";
                        uploadStatusDiv.style.display = "block";
                        
                        const formData = new FormData();
                        formData.append('file', audioBlob, 'recording.webm');
                        
                        // 使用实际的公网地址
                        const response = await fetch('https://ai.mcell.top/api/upload_voice', {
                            method: 'POST',
                            body: formData
                        });
                        
                        // 检查响应状态
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`上传失败: ${response.status} ${response.statusText} - ${errorText}`);
                        }
                        
                        // 解析JSON响应
                        const data = await response.json();
                        
                        // 检查响应结构
                        if (data.message !== '文件上传成功') {
                            throw new Error(data.error || "上传失败，服务器返回未知错误");
                        }
                        
                        // 构造完整的音频URL
                        const fullAudioUrl = `https://ai.mcell.top${data.url}`;
                        audioUrl = fullAudioUrl; // 保存上传后的完整URL
                        
                        // 显示上传成功
                        uploadStatusDiv.textContent = "语音文件上传成功！";
                        uploadStatusDiv.className = "upload-status upload-success";
                        sendVoiceBtn.disabled = false;
                    } catch (error) {
                        console.error('上传失败:', error);
                        uploadStatusDiv.textContent = `上传失败: ${error.message}`;
                        uploadStatusDiv.className = "upload-status upload-error";
                    } finally {
                        recordingStatusDiv.style.display = 'none';
                    }
                };
                
                mediaRecorder.start();
                recordBtn.disabled = true;
                stopBtn.disabled = false;
                recordingStatusDiv.style.display = 'block';
                uploadStatusDiv.style.display = 'none';
                sendVoiceBtn.disabled = true;
                audioUrl = null; // 重置URL
            } catch (error) {
                console.error('录音失败:', error);
                addMessage('系统', '无法访问麦克风，请检查权限设置', 'error');
            }
        });
        
        // 停止录音
        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                recordBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });
        
        // 发送语音消息
        sendVoiceBtn.addEventListener('click', () => {
            const roleId = roleIdInput.value.trim();
            
            if (!roleId) {
                alert('请输入角色ID');
                return;
            }
            
            if (!audioUrl) {
                alert('请先录制并上传语音');
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('WebSocket未连接');
                return;
            }
            
            // 发送语音消息 - 使用实际的公网地址
            try {
                const messageData = {
                    role_id: parseInt(roleId),
                    message: audioUrl, // 发送语音URL
                    type: "voice",
                    format: "webm",
                    response_type: selectedMode
                };
                
                socket.send(JSON.stringify(messageData));
                
                // 在界面上显示用户消息
                addMessage('用户', '语音消息已发送', 'user');
                
                // 重置状态
                sendVoiceBtn.disabled = true;
                audioUrl = null;
            } catch (error) {
                addMessage('系统', `发送失败: ${极狐error.message}`, 'error');
            }
        });
        
        // 添加消息到聊天界面 - 修复消息框消失问题
        function addMessage(sender, content, type, audioElement = null) {
            const messageDiv = document.createElement('div');
            
            // 设置消息类型
            if (type === 'user') {
                messageDiv.className = 'message user-message';
            } else if (type === 'ai') {
                messageDiv.className = 'message ai-message';
            } else if (type === 'system') {
                messageDiv.className = 'message system-message';
            } else if (type === 'error') {
                messageDiv.className = 'message error-message';
            }
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = `${sender} - ${new Date().toLocaleTimeString()}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            if (audioElement) {
                messageDiv.appendChild(audioElement);
            }
            
            chatMessagesDiv.appendChild(messageDiv);
            
            // 滚动到底部
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        
        // 按Enter发送消息
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    </script>
</body>
</html>
