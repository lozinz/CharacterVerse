<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音通话功能测试 - 队列播放优化版</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f0f0f0;
        }
        .audio-container {
            margin-top: 20px;
        }
        .log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .performance-monitor {
            margin-top: 10px;
            padding: 8px;
            background-color: #e8f4fc;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .buffer-indicator {
            margin-top: 10px;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .buffer-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        .buffer-warning {
            background-color: #ff9800;
        }
        .buffer-critical {
            background-color: #f44336;
        }
        .latency-graph {
            margin-top: 10px;
            height: 60px;
            border: 1px solid #ddd;
            position: relative;
            overflow: hidden;
        }
        .latency-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background-color: #4CAF50;
            transition: height 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>语音通话功能测试 - 队列播放优化版</h1>
        
        <div class="input-group">
            <label for="jwt">JWT Token:</label>
            <input type="text" id="jwt" placeholder="输入JWT认证令牌">
        </div>
        
        <div class="input-group">
            <label for="roleId">角色ID:</label>
            <input type="number" id="roleId" placeholder="输入角色ID">
        </div>
        
        <div class="input-group">
            <button id="connectBtn">连接WebSocket</button>
            <button id="recordBtn" disabled>开始录音</button>
            <button id="stopBtn" disabled>停止录音</button>
        </div>
        
        <div class="status">
            <strong>状态:</strong> <span id="status">未连接</span>
        </div>
        
        <div class="audio-container">
            <audio id="audioPlayer" controls></audio>
        </div>
        
        <div class="performance-monitor">
            <strong>性能监控:</strong>
            <div id="performanceInfo">缓冲区: 0 | 状态: 空闲 | 延迟: 0ms</div>
            <div class="buffer-indicator">
                <div class="buffer-fill" id="bufferFill"></div>
            </div>
            <div class="latency-graph" id="latencyGraph"></div>
        </div>
        
        <div class="log">
            <strong>日志:</strong>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        // 全局变量
        let mediaRecorder;
        let audioChunks = [];
        let ws;
        let audioContext;
        let lastNetworkLatency = 0;
        let bufferSizeHistory = [];
        let isPlaying = false;
        let latencyHistory = [];
        let bufferCheckInterval;
        let latencyGraphInterval;
        
        // 音频队列管理
        let audioQueue = []; // 存储所有接收到的音频片段
        let isFinalReceived = false; // 是否收到结束标记
        let currentAudioSource = null; // 当前播放的音频源
        
        // DOM元素
        const jwtInput = document.getElementById('jwt');
        const roleIdInput = document.getElementById('roleId');
        const connectBtn = document.getElementById('connectBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const audioPlayer = document.getElementById('audioPlayer');
        const logContent = document.getElementById('logContent');
        const statusElement = document.getElementById('status');
        const performanceInfo = document.getElementById('performanceInfo');
        const bufferFillElement = document.getElementById('bufferFill');
        const latencyGraphElement = document.getElementById('latencyGraph');
        
        // 添加日志
        function addLog(message) {
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // 更新状态
        function updateStatus(message) {
            statusElement.textContent = message;
            addLog(`状态更新: ${message}`);
        }
        
        // 更新性能信息
        function updatePerformanceInfo() {
            const bufferSize = audioQueue.length;
            const status = isPlaying ? '播放中' : '空闲';
            const avgBuffer = bufferSizeHistory.length > 0 ? 
                Math.round(bufferSizeHistory.reduce((a, b) => a + b, 0) / bufferSizeHistory.length) : 0;
            
            // 计算平均延迟
            const avgLatency = latencyHistory.length > 0 ? 
                Math.round(latencyHistory.reduce((a, b) => a + b, 0) / latencyHistory.length) : 0;
            
            performanceInfo.textContent = 
                `缓冲区: ${bufferSize} | 状态: ${status} | 平均延迟: ${avgLatency}ms`;
            
            // 更新缓冲指示器
            const bufferFill = Math.min(100, Math.max(0, bufferSize * 10)); // 每个片段增加10%
            
            bufferFillElement.style.width = `${bufferFill}%`;
            bufferFillElement.className = 'buffer-fill';
            
            if (bufferSize < 3) {
                bufferFillElement.classList.add('buffer-warning');
            }
            if (bufferSize < 1) {
                bufferFillElement.classList.add('buffer-critical');
            }
        }
        
        // 更新延迟图表
        function updateLatencyGraph() {
            // 清除旧图表
            latencyGraphElement.innerHTML = '';
            
            // 添加新的延迟条
            latencyHistory.slice(-30).forEach((latency, index) => {
                const bar = document.createElement('div');
                bar.className = 'latency-bar';
                bar.style.left = `${index * 5}px`;
                
                // 根据延迟值设置高度和颜色
                const height = Math.min(60, Math.max(5, latency / 2));
                bar.style.height = `${height}px`;
                
                if (latency > 300) {
                    bar.style.backgroundColor = '#f44336'; // 红色表示高延迟
                } else if (latency > 150) {
                    bar.style.backgroundColor = '#ff9800'; // 橙色表示中等延迟
                } else {
                    bar.style.backgroundColor = '#4CAF50'; // 绿色表示低延迟
                }
                
                bar.title = `延迟: ${latency}ms`;
                latencyGraphElement.appendChild(bar);
            });
        }
        
        // 连接WebSocket
        connectBtn.addEventListener('click', async () => {
            const jwt = jwtInput.value.trim();
            const roleId = roleIdInput.value.trim();
            
            if (!jwt) {
                alert('请输入JWT Token');
                return;
            }
            
            if (!roleId) {
                alert('请输入角色ID');
                return;
            }
            
            // 创建WebSocket连接
            ws = new WebSocket(`ws://localhost:8080/api/ws/voice_chat?token=${jwt}`);
            
            ws.onopen = () => {
                updateStatus('WebSocket已连接');
                recordBtn.disabled = false;
                connectBtn.disabled = true;
                
                // 初始化音频上下文
                initAudioContext();
                
                // 开始性能监控
                bufferCheckInterval = setInterval(() => {
                    bufferSizeHistory.push(audioQueue.length);
                    if (bufferSizeHistory.length > 10) bufferSizeHistory.shift();
                    updatePerformanceInfo();
                }, 500);
                
                // 开始延迟图表更新
                latencyGraphInterval = setInterval(updateLatencyGraph, 1000);
            };
            
            ws.onmessage = (event) => {
                const receiveTime = Date.now();
                try {
                    const response = JSON.parse(event.data);
                    
                    if (response.type === 'audio') {
                        // 计算网络延迟
                        if (response.timestamp) {
                            lastNetworkLatency = Date.now() - response.timestamp;
                            latencyHistory.push(lastNetworkLatency);
                            if (latencyHistory.length > 50) latencyHistory.shift();
                        }
                        
                        addLog(`收到音频片段 (格式: ${response.format}, 长度: ${response.data.length}字节, 延迟: ${lastNetworkLatency}ms)`);
                        
                        // 添加到音频队列
                        audioQueue.push({
                            data: response.data,
                            isFinal: response.isFinal
                        });
                        
                        // 如果是结束标记
                        if (response.isFinal) {
                            isFinalReceived = true;
                            addLog('收到结束标记');
                        }
                        
                        // 如果没有在播放，开始播放
                        if (!isPlaying) {
                            playNextAudio();
                        }
                        
                    } else if (response.type === 'error') {
                        addLog(`错误: ${response.data}`);
                        updateStatus(`错误: ${response.data}`);
                    }
                } catch (error) {
                    addLog(`解析消息错误: ${error.message}`);
                }
            };
            
            ws.onerror = (error) => {
                addLog(`WebSocket错误: ${error.message}`);
                updateStatus('WebSocket连接错误');
            };
            
            ws.onclose = () => {
                updateStatus('WebSocket已断开');
                recordBtn.disabled = true;
                connectBtn.disabled = false;
                clearInterval(bufferCheckInterval);
                clearInterval(latencyGraphInterval);
            };
        });
        
        // 初始化音频上下文
        function initAudioContext() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        latencyHint: 'playback'
                    });
                    addLog(`Web Audio API已初始化 (采样率: ${audioContext.sampleRate}Hz)`);
                }
                return audioContext;
            } catch (error) {
                addLog(`无法初始化Web Audio API: ${error.message}`);
                return null;
            }
        }
        
        // 播放下一个音频片段
        function playNextAudio() {
            if (!audioContext || audioQueue.length === 0 || isPlaying) {
                return;
            }
            
            try {
                const audioItem = audioQueue.shift();
                const base64Data = audioItem.data;
                
                // 解码base64音频数据
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                
                // 解码音频数据
                audioContext.decodeAudioData(byteArray.buffer)
                    .then(audioBuffer => {
                        isPlaying = true;
                        updateStatus('播放中...');
                        
                        // 创建音频源
                        currentAudioSource = audioContext.createBufferSource();
                        currentAudioSource.buffer = audioBuffer;
                        
                        // 连接到输出
                        currentAudioSource.connect(audioContext.destination);
                        
                        // 播放音频
                        currentAudioSource.start();
                        
                        // 设置播放结束回调
                        currentAudioSource.onended = () => {
                            addLog(`音频片段播放完成 (时长: ${audioBuffer.duration.toFixed(2)}秒)`);
                            isPlaying = false;
                            
                            // 检查是否是最后一个片段
                            if (audioItem.isFinal || isFinalReceived) {
                                updateStatus('播放完成');
                                isFinalReceived = false;
                            } else if (audioQueue.length > 0) {
                                // 播放下一个片段
                                setTimeout(playNextAudio, 0);
                            } else {
                                updateStatus('等待更多数据...');
                            }
                        };
                        
                        addLog(`开始播放音频片段 (时长: ${audioBuffer.duration.toFixed(2)}秒)`);
                    })
                    .catch(error => {
                        addLog(`音频解码错误: ${error.message}`);
                        isPlaying = false;
                        updateStatus('解码失败');
                        
                        // 尝试播放下一个片段
                        if (audioQueue.length > 0) {
                            setTimeout(playNextAudio, 0);
                        }
                    });
                
            } catch (error) {
                addLog(`播放错误: ${error.message}`);
                isPlaying = false;
                updateStatus('播放失败');
                
                // 尝试播放下一个片段
                if (audioQueue.length > 0) {
                    setTimeout(playNextAudio, 0);
                }
            }
        }
        
        // 开始录音
        recordBtn.addEventListener('click', async () => {
            try {
                updateStatus('正在获取麦克风权限...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                updateStatus('正在准备录音...');
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                
                // 创建MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    updateStatus('正在处理录音...');
                    
                    // 创建Blob并转换为WAV
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    try {
                        // 上传录音文件
                        updateStatus('正在上传录音...');
                        const formData = new FormData();
                        formData.append('file', audioBlob, 'recording.wav');
                        
                        const uploadResponse = await fetch('https://ai.mcell.top/api/upload_voice', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const uploadData = await uploadResponse.json();
                        
                        if (uploadData.url) {
                            const voiceUrl = `https://ai.mcell.top${uploadData.url}`;
                            addLog(`录音上传成功: ${voiceUrl}`);
                            
                            // 通过WebSocket发送语音消息
                            const message = {
                                role_id: parseInt(roleIdInput.value),
                                voice_url: voiceUrl,
                                format: 'wav',
                                timestamp: Date.now() // 添加时间戳用于延迟计算
                            };
                            
                            ws.send(JSON.stringify(message));
                            updateStatus('语音消息已发送，等待响应...');
                        } else {
                            throw new Error('上传失败: ' + JSON.stringify(uploadData));
                        }
                    } catch (error) {
                        addLog(`上传错误: ${error.message}`);
                        updateStatus('上传失败');
                    }
                };
                
                // 开始录音
                mediaRecorder.start();
                updateStatus('录音中...');
                recordBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (error) {
                addLog(`录音错误: ${error.message}`);
                updateStatus('无法访问麦克风');
            }
        });
        
        // 停止录音
        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                updateStatus('录音已停止');
                recordBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });
        
        // 清理资源
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (mediaRecorder) mediaRecorder.stop();
            clearInterval(bufferCheckInterval);
            clearInterval(latencyGraphInterval);
            
            // 停止当前播放
            if (currentAudioSource) {
                currentAudioSource.stop();
            }
        });
        
        // 自动播放策略
        document.addEventListener('click', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    addLog('用户交互后恢复音频上下文');
                });
            }
        });
    </script>
</body>
</html>
